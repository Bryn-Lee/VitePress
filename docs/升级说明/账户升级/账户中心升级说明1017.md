# 账户中心系统版本

| 模块   | 升级前版本号           | 升级后版本号          |
| ---- | :--------------- | --------------- |
| 账户中心 | unicenter1.0.16* | unicenter1.0.17 |
| v6s  | V6.11.0.1        |                 |
| v8s  | v1.1.0.1         |                 |


# 升级说明

## 1.  升级时间

当天开户部门工作结束。

# 升级步骤

## 2.  停止账户中心应用服务

1)    执行/unicenter/unicenter_stop.sh 停止所有的进程。执行ps -ef|grep java检查是否存在遗留进程。
```bash
[root@localhost /]# cd /
[root@localhost /]# cd unicenter/
[root@localhost unicenter]# ./unicenter_stop.sh
[root@localhost unicenter]# ps -ef|grep java
```

## 3.  备份应用程序

1)    登录应用程序服务器，执行/unicenter/backup/backup.sh备份所有程序包。
```shell
[root@localhost /]# cd /
[root@localhost /]# cd unicenter/backup/
[root@localhost backup]# ./backup.sh
```
## 4.  更新脚本

1)    将 <span style="background:#fff88f"><font color="#ff0000">脚本/应用服务</font></span> 中 update.sh 上传至/unicenter/update/中，存在则替换。
1)    将 <span style="background:#fff88f"><font color="#ff0000">脚本/数据库</font></span> 中 ora_backup上传至/ora_backup/中，存在则替换。修改 config.sh 中的配置
3)    将 <span style="background:#fff88f"><font color="#ff0000">脚本/数据库</font></span> 中 ora_update 上传至/ora_update/中，存在则替换。修改 config.sh 中的配置
4)    脚本赋予执行权限

## 5.  升级数据库

1)   执行/ora_backup/unicenter_expdp.sh 备份数据库；备份成功会在/ora_backup中产生一个日期文件夹，里面存在一个dmp数据文件，文件不存在或文件过小则备份不成功。
```shell
[oracle@localhost ~]$ cd /
[oracle@localhost /]$ cd ora_backup
[oracle@localhost ora_backup]$ ./unicenter_expdp.sh
```
3)   将 <span style="background:#fff88f"><font color="#ff0000">脚本/数据库</font></span> 中的ora_update文件夹上传至根目录，存在则删除替换。并用oracle用户赋权限；
```shell
[oracle@localhost /]$ chown oracle:oinstall –R /ora_update
[oracle@localhost /]$ chmod  +x  /ora_update/unicenter_database_update.sh
```
4)   将 <span style="background:#fff88f"><font color="#ff0000">数据库</font></span> 中的所有文件上传至/ora_update/update下
5)   oracle用户执行/ora_update/unicenter_database_update.sh
```shell
[oracle@localhost /]$ cd /
[oracle@localhost /]$ cd ora_update/
[oracle@localhost ora_update]$ ./unicenter_database_update.sh
```
## 6.  升级应用程序

1)   登录应用程序服务器， 将 <span style="background:#fff88f"><font color="#ff0000"><font color="#ff0000">tomcat文件夹</font></font></span>上传至/unicenter/update/中
2)   将 <span style="background:#fff88f"><font color="#ff0000">five文件夹</font></span>上传至/unicenter/update/中
3)   将 <span style="background:#fff88f"><font color="#ff0000">unicenter-sync文件夹</font></span>上传至/unicenter/update/中
4)   执行/unicenter/update/update.sh
```shell
[root@localhost /]# cd unicenter/update/
[root@localhost update]# ./update.sh
```

## 7.  修改配置文件
  1)   编辑/unicenter/tomcat/webapps/ks/wb/system/var.json ，在serverId 下方插入showWater 部分，保存。

 ```json
  "serverId": [
    "00",
    "集群环境下任意两位字符的服务器编号。",
    {"type": "string"}
  ],
  "showWater": [
    false,
    "是否显示水印",
    {"type": "bool"}
  ],
  "network": {
    "showSocketError": [
      true,
      "是否显示WebSocket的Error事件中的错误信息。",
      {"type": "bool"}
    ],
 ```
2. 编辑/unicenter/unicenter-sync/application-prod.yml，在 mapping: futures:行最后添加  ,851089 。完整配置如下：

 ```
  cpack:
    funcno:
      mapping: futures:858202,858222,851400,851343,851349,851342,851348,859801,859745,851075,859589,859553,859551,859581,859580,859583,859582,859786,859785,859523,859524,855605,855608,859729,851217,855607,859556,859522,859531,851018,859526,859517,859790,859792,859515,859783,859711,859514,859516,851007,859515,859783,851007,851010,851008,859537,859523,859779,859542,851005,851005,854151,854152,854227,854228,851277,851278,851075,859598,859605,859606,851401,852002,851400,851464,853011,851028,851203,852117,851345,851347,851081,851050,851026,851090,851086,851089

 ```

3. 删除/unicenter/unicenter-sync/application-prod.yml 中的配置：

 ```
    # 新开户同步初始密码（交易，资金，委托）
    open-account-sync-pwd: true
    # 主动更新权限模板(v6s)
    update-auth-template: false
    # 主动更新交易中心(v6s)
    update-trading-center: false
 ```

## 8.  组件升级（可选）

1.  tomcat (9.0.80)可参考组件/Apache-tomcat版本升级.pdf 进行升级。
2.  nginx (1.24.0)可参考 组件/nginx卸载安装升级.pdf 进行升级。

## 9.  启动所有程序

执行/unicenter/unicenter_start.sh 启动所有的程序，升级完成。执行ps -ef|grep java检查进程是否正常启动。
```shell
[root@localhost /]# cd /
[root@localhost /]# cd unicenter/
[root@localhost unicenter]# ./unicenter_start.sh
[root@localhost unicenter]# ps -ef|grep java
```
