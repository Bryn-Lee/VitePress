# 账户中心系统版本

| 模块     | 升级前版本号     | 升级后版本号    | 备注 |
| -------- | :--------------- | --------------- | ---- |
| 账户中心 | unicenter1.0.18* | unicenter1.0.19 |      |


# 升级说明

## 1.  升级时间

当天开户部门工作结束，跳过休眠上报窗口期。

# 升级步骤

## 2.  停止账户中心应用服务

1)    执行/unicenter/unicenter_stop.sh 停止所有的进程。执行ps -ef|grep java检查是否存在遗留进程。
```bash
[root@localhost /]# cd /unicenter/
[root@localhost unicenter]# ./unicenter_stop.sh
[root@localhost unicenter]# ps -ef|grep java
```

## 3.  备份应用程序

1)    登录应用程序服务器，执行/unicenter/backup/backup.sh备份所有程序包。
```shell
[root@localhost /]# cd /unicenter/backup/
[root@localhost backup]# ./backup.sh
```
## 4.  升级数据库

1)   执行/ora_backup/unicenter_expdp.sh 备份数据库；备份成功会在/ora_backup中产生一个日期文件夹，里面存在一个dmp数据文件，文件不存在或文件过小则备份不成功。
```shell
[oracle@localhost /]$ cd /ora_backup
[oracle@localhost ora_backup]$ ./unicenter_expdp.sh
```
2. 将 <span style="background:#fff88f"><font color="#ff0000">数据库</font></span> 中的所有文件上传至/ora_update/update下

3. oracle用户执行/ora_update/unicenter_database_update.sh

```shell
[oracle@localhost /]$ cd /ora_update/
[oracle@localhost ora_update]$ ./unicenter_database_update.sh
```
4. 登录数据库用户CF_ACCOUNT（密码默认为wolf），SQL窗口中执行 <span style="background:#fff88f"><font color="#ff0000"><font color="#ff0000">补充数据库脚本/多业务数据拆分.sql</font></font></span>，没有报错手动或执行commit 提交结果，有报错或者其他问题及时联系处理，不可提交。注意此步中的sql脚本只可执行一次！不可重复执行！
4. （天富期货跳过此步）登录数据库用户CF_ACCOUNT（密码默认为wolf），SQL窗口中执行 <span style="background:#fff88f"><font color="#ff0000"><font color="#ff0000">补充数据库脚本/受益人判定方式存量客户数据处理.sql</font></font></span>，没有报错手动或执行commit 提交结果，有报错或者其他问题及时联系处理，不可提交。注意此步中的sql脚本只可执行一次！不可重复执行！

## 5.  升级应用程序

1)   登录应用程序服务器， 将 <span style="background:#fff88f"><font color="#ff0000"><font color="#ff0000">tomcat文件夹</font></font></span>上传至/unicenter/update/中
2)   将 <span style="background:#fff88f"><font color="#ff0000">five文件夹</font></span>上传至/unicenter/update/中
3)   将 <span style="background:#fff88f"><font color="#ff0000">report文件夹</font></span>上传至/unicenter/update/中
4)   将 <span style="background:#fff88f"><font color="#ff0000">unicenter-sync文件夹</font></span>上传至/unicenter/update/中
5)   执行/unicenter/update/update.sh
6)   将 <span style="background:#fff88f"><font color="#ff0000">脚本/应用服务/var.sh</font></span>  上传至/unicenter/update/中，赋予执行权限， 执行/unicenter/update/var.sh （此命令只可执行一次！，不可重复执行）
```shell
[root@localhost /]# cd /unicenter/update/
[root@localhost update]# ./update.sh
[root@localhost update]# ./var.sh
```



## 6. 新增配置

1. 修改 /unicenter/report/application-prod.yml,在最后新增以下配置，参考升级包中配置文件修改，注意配置项前后空格，最好复制粘贴。

   ```
   system:
     # ip白名单，多个使用逗号拼接，为空时不拦截
     whiteIps:
     # 上报程序用户名
     username: report
     # 上报程序密码   SHA256 哈希算法加盐加密后的密文
     password: gu99Ll8rFb1BsChPybm81z9mudh1QpcLB/dBolli3Dk=
     # 盐值
     salt: report
   ```

   

2. 修改 /unicenter/unicenter-sync/application-prod.yml,新增以下配置，参考升级包中配置文件修改，注意配置项前后空格，最好复制粘贴。

   

   ```
   spring:
     datasource:
       factory: default #新增此项
   ......
     counters:
       v6s: true
       v8s: true
       ctp2: false #没有此项新增此项，默认false
       cap: false #新增此项，默认false
     configs:
   ......
   system:
     # ip白名单，多个使用逗号拼接
     whiteIps: 
     # 同步程序用户名
     username: sync
     # 同步程序密码   SHA256 哈希算法加盐加密后的密文
     password: Tx0fA5x6ZTsplE0f/eBBaTQMRa9VO6tyPXsOwEHFbi0=
     # 盐值
     salt: sync
   ```

   

3. 修改 /unicenter/tomcat/webapps/ks/WEB-INF/classes/config/report.properties 配置，配置上报程序地址，注意如果上报程序配置了ssl（参考第8节），使用https，否则使用 http。

   

   ```
   # 上报程序地址
   report_login_url = https://127.0.0.1:8001/report/token
   # 上报程序用户名
   report_username = report
   # 上报程序密码
   report_password = v4Qzc4Qg+nyfbe4a8fOErA==
   # 加密key
   report_key = vioRitX/PPVVkZv41HrBXg==
   ```

   

4. 修改/unicenter/tomcat/webapps/ks/WEB-INF/classes/config/sync.properties 配置，配置同步程序地址，注意如果同步程序配置了ssl（参考第8节），使用https，否则使用 http。

   ```
   # 同步程序地址
   sync_login_url = https://127.0.0.1:8102/unicenter/token/accessToken
   # 同步程序用户名
   sync_username = sync
   # 同步程序密码
   sync_password = SIaUVRVclst9NiQkUrh07w==
   # 加密key
   sync_key = eJNv+svlBAj/ScF+Rgaoaw==
   ```

## 7.  启动所有程序

执行/unicenter/unicenter_start.sh 启动所有的程序，升级完成。执行ps -ef|grep java检查进程是否正常启动。
```shell
[root@localhost /]# cd /unicenter/
[root@localhost unicenter]# ./unicenter_start.sh
[root@localhost unicenter]# ps -ef|grep java
```



## 8.其他升级（根据实际情况选择升级，无强制要求，如果已经配置可以忽略）

如果同步程序需要配置为https访问，sync程序可配置 ssl

1. 编辑/unicenter/unicenter-sync/application.yml，新增ssl配置项，将unicenter-sync 文件夹中默认提供的证书文件 unicenter.keystore 放入/unicenter/unicenter-sync/ 中，也可根据自身情况使用证书。修改完成后重启 sync 程序生效。 

   ```
   server:
     port: 8102
     servlet:
       context-path: /unicenter
     ssl:
       #证书路径 按证书的实际绝对路径配置
       key-store: /unicenter/unicenter-sync/unicenter.keystore
       #key store的类型
       key-store-type: PKCS12
       #访问key store的密码
       key-store-password: unicenter
       #store中key的别名
       key-alias: unicenter
   spring:
     profiles:
       active: prod
   
   ```

2. 修改同步程序配置

   前往 账户管理>系统配置 菜单，修改 柜台配置目录中的同步程序地址http为 https

![](https://gitee.com/leonblack/ImgURL/raw/master/image/2024913/67o8vuo4uf1726196001122.png)

如果上报程序需要配置为https访问，report程序可配置 ssl

1. 编辑/unicenter/report/application.properties，新增以下部分配置项，默认提供unicenter.keystore ， 也可根据自身情况使用证书。修改完成后重启 report程序生效。 

```
##持有SSL certificate的key store的路径
server.ssl.key-store=/unicenter/report/unicenter.keystore 
##key store的类型
server.ssl.key-store-type=PKCS12
##访问key store的密码
server.ssl.key-store-password=unicenter
##store中key的别名
server.ssl.key-alias=unicenter
```

2. 前往 账户管理>系统配置 菜单，修改统一上报目录中的统一上报地址为 https

   ![](https://gitee.com/leonblack/ImgURL/raw/master/image/20231218/ccj1sx0sq91702877953254.png)
