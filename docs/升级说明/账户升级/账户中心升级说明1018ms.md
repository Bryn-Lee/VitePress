# 账户中心系统版本

| 模块 | 升级前版本号 | 升级后版本号 |
| ------ | :----- | ------ |
| 账户中心 | unicenter1.0.17* | unicenter1.0.18 |


# 升级说明

## 1.  升级时间

当天开户部门工作结束。

# 升级步骤

## 2.  停止账户中心应用服务

1)    执行/unicenter/unicenter_stop.sh 停止所有的进程。执行ps -ef|grep java检查是否存在遗留进程。
```bash
[root@localhost /]# cd /unicenter/
[root@localhost unicenter]# ./unicenter_stop.sh
[root@localhost unicenter]# ps -ef|grep java
```

## 3.  备份应用程序

1)    登录应用程序服务器，执行/unicenter/backup/backup.sh备份所有程序包。
```shell
[root@localhost /]# cd /unicenter/backup/
[root@localhost backup]# ./backup.sh
```
## 4.  升级数据库

1)   执行/ora_backup/unicenter_expdp.sh 备份数据库；备份成功会在/ora_backup中产生一个日期文件夹，里面存在一个dmp数据文件，文件不存在或文件过小则备份不成功。
```shell
[oracle@localhost /]$ cd /ora_backup
[oracle@localhost ora_backup]$ ./unicenter_expdp.sh
```
2. 删除 /ora_update/update中的内容，将 <span style="background:#fff88f"><font color="#ff0000">数据库</font></span> 中的所有文件上传至/ora_update/update下

3. oracle用户执行/ora_update/unicenter_database_update.sh

```shell
[oracle@localhost /]$ cd /ora_update/
[oracle@localhost ora_update]$ ./unicenter_database_update.sh
```
## 5.  更新脚本

1)    将 <span style="background:#fff88f"><font color="#ff0000">脚本/应用服务</font></span> 中 update.sh 上传至/unicenter/update/中，存在则替换。
1)    所有脚本赋予执行权限

## 6.  升级应用程序

1)   登录应用程序服务器， 将 <span style="background:#fff88f"><font color="#ff0000"><font color="#ff0000">tomcat文件夹</font></font></span>上传至/unicenter/update/中
2)   将 <span style="background:#fff88f"><font color="#ff0000">unicenter-sync文件夹</font></span>上传至/unicenter/update/中
3)   将 <span style="background:#fff88f"><font color="#ff0000">report文件夹</font></span>上传至/unicenter/update/中
4)   执行/unicenter/update/update.sh

```shell
[root@localhost /]# cd /unicenter/update/
[root@localhost update]# ./update.sh
```

## 7.  新增配置

1. 修改 /unicenter/tomcat/webapps/ks/wb/system/var.json,新增 Encrypt 相关配置，在  <span style="background:#fff88f"><font color="#ff0000">{"sys": {</font></span>  后 ， <span style="background:#fff88f"><font color="#ff0000"> "controls": { </font></span> 前插入，注意逗号分隔符。

   ```
   {"sys": {
     "Encrypt": {"EncryptWay": [
       "SHA256_SALT",
       "数据库密码加密算法",
       {"type": "string"}
     ]},
     "controls": {
       "filterDataPermission": [
   ```


2. 修改 /unicenter/unicenter-sync/application-prod.yml,新增以下配置，参考升级包中配置文件修改，注意配置项前后空格，最好复制粘贴。

   ```
   spring:
     datasource:
       factory: default #新增此项
   ......
     counters:
       v6s: false
       v8s: true
       ctp2: false 
       cap: false #新增此项，默认false
     configs:
   ......
   ```

## 8.  启动所有程序

1. 执行/unicenter/unicenter_start.sh 启动所有的程序，升级完成。执行ps -ef|grep java检查进程是否正常启动。

```shell
[root@localhost /]# cd /unicenter/
[root@localhost unicenter]# ./unicenter_start.sh
[root@localhost unicenter]# ps -ef|grep java
```

## 9.  注意事项

​	升级后，admin账户默认密码变更为  Ks123456789! ，其他用户密码全部失效，需要重设才可以登录。

