# 账户中心系统版本

| 模块 | 升级前版本号 | 升级后版本号 |
| ------ | :----- | ------ |
| 账户中心 | unicenter1.0.17-2 | unicenter1.0.17-3 |


# 升级说明

## 1.  升级时间

当天开户部门工作结束。

# 升级步骤

## 2.  停止账户中心应用服务

1)    执行/unicenter/unicenter_stop.sh 停止所有的进程。执行ps -ef|grep java检查是否存在遗留进程。
```bash
[root@localhost /]# cd /unicenter/
[root@localhost unicenter]# ./unicenter_stop.sh
[root@localhost unicenter]# ps -ef|grep java
```

## 3.  备份应用程序

1)    登录应用程序服务器，执行/unicenter/backup/backup.sh备份所有程序包。
```shell
[root@localhost /]# cd /unicenter/backup/
[root@localhost backup]# ./backup.sh
```
## 4.  升级数据库

1)   执行/ora_backup/unicenter_expdp.sh 备份数据库；备份成功会在/ora_backup中产生一个日期文件夹，里面存在一个dmp数据文件，文件不存在或文件过小则备份不成功。
```shell
[oracle@localhost /]$ cd /ora_backup
[oracle@localhost ora_backup]$ ./unicenter_expdp.sh
```
2. 删除 /ora_update/update中的内容，将 <span style="background:#fff88f"><font color="#ff0000">数据库</font></span> 中的所有文件上传至/ora_update/update下

3. oracle用户执行/ora_update/unicenter_database_update.sh

```shell
[oracle@localhost /]$ cd /ora_update/
[oracle@localhost ora_update]$ ./unicenter_database_update.sh
```
## 5.  更新脚本

1)    将 <span style="background:#fff88f"><font color="#ff0000">脚本/应用服务</font></span> 中 update.sh 上传至/unicenter/update/中，存在则替换。
1)    所有脚本赋予执行权限

## 6.  升级应用程序

1)   登录应用程序服务器， 将 <span style="background:#fff88f"><font color="#ff0000"><font color="#ff0000">tomcat文件夹</font></font></span>上传至/unicenter/update/中
2)   将 <span style="background:#fff88f"><font color="#ff0000">unicenter-sync文件夹</font></span>上传至/unicenter/update/中
3)   将 <span style="background:#fff88f"><font color="#ff0000">report文件夹</font></span>上传至/unicenter/update/中
4)   执行/unicenter/update/update.sh

```shell
[root@localhost /]# cd /unicenter/update/
[root@localhost update]# ./update.sh
```

## 7.  新增配置

1. 修改 /unicenter/report/application-prod.yml,在最后新增以下配置，可根据具体情况修改配置，密码生成参考 密文生成的描述。

   ```
   system:
     # ip白名单，多个使用逗号拼接，为空时不拦截
     whiteIps:
     # 上报程序用户名
     username: report
     # 上报程序密码   SHA256 哈希算法加盐加密后的密文
     password: 7MT4XuYidY1MG0xCFgssghJz9J3faHGs4HJW42GQ4CA=
     # 盐值
     salt: qwer
   ```

   

2. 修改 /unicenter/unicenter-sync/application-prod.yml,在最后新增以下配置，可根据具体情况修改配置，密码生成参考 密文生成的描述。

   

   ```
   system:
     # ip白名单，多个使用逗号拼接，为空时不拦截
     whiteIps:
     # 同步程序用户名
     username: admin
     # 同步程序密码   SHA256 哈希算法加盐加密后的密文
     password: 76V0dNJY5Xf8L5+BN2YKxgp9qDcpm6aONooPoBsJV5k=
     # 盐值
     salt: qwer
   ```

   

3. 修改 /unicenter/tomcat/webapps/ks/WEB-INF/classes/config/report.properties 配置，配置上报程序地址，注意密码和上报程序密码使用同一套，密码生成参考 密文生成的描述。

   

   ```
   # 上报程序地址
   report_login_url = https://127.0.0.1:8001/report/token
   # 上报程序用户名
   report_username = report
   # 上报程序密码
   report_password = wfPJzMimHzigGUxPYCjK9g==
   # 加密key
   report_key = wHm2qcHQxV4aS20grFgzmA==
   ```

   

4. 修改/unicenter/tomcat/webapps/ks/WEB-INF/classes/config/sync.properties 配置，配置同步程序地址，注意和同步程序密码使用同一套密码，密码生成参考 密文生成的描述。

   ```
   # 同步程序地址
   sync_login_url = https://127.0.0.1:8102/unicenter/token/accessToken
   # 同步程序用户名
   sync_username = sync
   # 同步程序密码
   sync_password = 0sNMv4W5fu+fgNRCAveNCg==
   # 加密key
   sync_key = 2Av5te1SDm58oO3lAs4rog==
   ```

5. 编辑/unicenter/unicenter-sync/application.yml，新增ssl配置项，将unicenter-sync 文件夹中默认提供的证书文件 unicenter.keystore 放入/unicenter/unicenter-sync/ 中，也可可根据自身情况使用证书。

      ```
      server:
        port: 8102
        servlet:
          context-path: /unicenter
        ssl:
          #证书路径 按证书的实际绝对路径配置
          key-store: /unicenter/unicenter-sync/unicenter.keystore
          #key store的类型
          key-store-type: PKCS12
          #访问key store的密码
          key-store-password: unicenter
          #store中key的别名
          key-alias: unicenter
      spring:
        profiles:
          active: prod
      ```

   

## 8.  启动所有程序

1. 执行/unicenter/unicenter_start.sh 启动所有的程序，升级完成。执行ps -ef|grep java检查进程是否正常启动。

```shell
[root@localhost /]# cd /unicenter/
[root@localhost unicenter]# ./unicenter_start.sh
[root@localhost unicenter]# ps -ef|grep java
```

## 9.  修改同步地址

   前往 账户管理>系统配置 菜单，修改 柜台配置 目录中的同步程序地址 http为 https
